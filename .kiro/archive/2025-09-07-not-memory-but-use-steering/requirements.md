# 要件定義: ファイルベースステアリングシステム

## 概要
現在のMemory MCP（SQLiteベース）システムを、Claude Code用の透明でバージョン管理可能なメモリ永続化を提供するファイルベースのステアリングシステムに変換します。新システムはメモリをマークダウンファイルとして`.kiro/steering/`ディレクトリに保存し、簡単にアクセス可能にして誤った上書きを防ぎます。

## 背景
### 現在の問題点
- SQLiteデータベースの内容が不透明で検査が困難
- メモリのバージョン管理がない
- データベース破損によるデータ損失のリスク
- チームメンバー間でメモリを簡単に共有できない

### 提案する解決策
- `.kiro/steering/`ディレクトリでのファイルベースストレージ
- 一時的なメモリ用のドラフトシステム
- 基準に基づく自動分類
- 誤った上書きに対する保護

## ユーザーストーリー

### 開発者として
- データベースへのクエリなしで保存されているメモリを確認したい。そうすることでClaude Codeが何を記憶しているかを理解できる
- ステアリングファイルをバージョン管理したい。そうすることで変更を追跡し、チームメンバーと共有できる
- 既存のステアリングファイルを上書きから保護したい。そうすることで重要なコンテキストを失わない

### Claude Codeユーザーとして
- 会話中に重要なコンテキストを素早く保存したい。そうすることで後で参照できる
- メモリを自動的に分類したい。そうすることで整理されて見つけやすくなる
- ステアリングファイルを手動でレビュー・編集したい。そうすることで保存された知識を洗練できる

## 機能要件

### FR1: ステアリングディレクトリ構造
- **FR1.1**: `hail-mary init`実行時に`.kiro/steering/`ディレクトリを作成
- **FR1.2**: 一時的なメモリ用のサブディレクトリ`.kiro/steering/draft/`を作成
- **FR1.3**: 設定に基づいてステアリングタイプファイルを作成（例：`structure.md`、`conventions.md`）
- **FR1.4**: `--force`フラグを使用しても既存のステアリングファイルを上書きしない

### FR2: 設定変更
- **FR2.1**: config.tomlの`[memory]`セクションを`[steering]`に変更
- **FR2.2**: 分類ルール用に各ステアリングタイプに`criterion`配列を追加
- **FR2.3**: `--force`フラグでconfig.tomlの上書きを防ぐ
- **FR2.4**: 適切な基準を持つデフォルトのステアリングタイプを定義

### FR3: スラッシュコマンド
- **FR3.1**: `/hm:steering-remember` - 現在の会話コンテキストをドラフトに保存
- **FR3.2**: `/hm:steering` - ドラフトファイルを処理し、適切なステアリングファイルに分類
- **FR3.3**: コマンドは`.claude/commands/hm/`ディレクトリで利用可能にする

### FR4: メモリ分類
- **FR4.1**: 基準に基づいてドラフトがどのステアリングタイプに属するかを自動的に判断
- **FR4.2**: 分類されたコンテンツを既存のステアリングファイルに追加（上書きしない）
- **FR4.3**: 成功した分類後に処理済みドラフトを削除

## 受け入れ基準

### AC1: 初期化
- [ ] `hail-mary init`が`.kiro/steering/`ディレクトリ構造を作成する
- [ ] デフォルトのステアリングタイプファイルがヘッダーと基準の説明と共に作成される
- [ ] 既存のステアリングファイルは決して上書きされない
- [ ] Config.tomlが`[memory]`の代わりに`[steering]`を使用する

### AC2: ドラフト管理
- [ ] `/hm:steering-remember`がドラフトディレクトリにタイムスタンプ付きマークダウンファイルを作成する
- [ ] ドラフトファイルが現在の会話からのコンテキストを含む
- [ ] ドラフトファイル名が説明的でケバブケースである

### AC3: 分類
- [ ] `/hm:steering`がすべてのドラフトファイルを読み取る
- [ ] 各ドラフトがステアリングタイプの基準に対して分析される
- [ ] ドラフトが適切なステアリングファイルに追加される
- [ ] 処理済みドラフトがドラフトディレクトリから削除される

### AC4: ファイル保護
- [ ] `--force`フラグが既存のステアリングファイルを上書きしない
- [ ] `--force`フラグがconfig.tomlを上書きしない
- [ ] init時に存在しないファイルのみが作成される

## 非機能要件

### NFR1: パフォーマンス
- ファイル操作は通常の操作で100ms以内に完了すること
- 分類は100個のドラフトを5秒以内に処理すること

### NFR2: 互換性
- マークダウンファイルは標準的なマークダウンビューアで読み取り可能であること
- ファイル構造はgitフレンドリーであること（バイナリファイルなし）

### NFR3: 使いやすさ
- 操作が失敗した時の明確なエラーメッセージ
- 分類の判断をデバッグするための詳細モード
- 人間が読みやすいステアリングファイル形式

## デフォルトステアリングタイプ

### 1. Structure（構造）
**目的**: コード組織とプロジェクト構造パターン
**基準**:
- ルートディレクトリ構成: 説明付きのトップレベル構造
- サブディレクトリ構造: 主要ディレクトリの詳細な内訳
- コード組織パターン: コードがどのように構造化されているか
- ファイル命名規則: ファイルとディレクトリの命名基準
- インポート組織: インポート/依存関係がどのように組織化されているか
- 主要なアーキテクチャ原則: コア設計決定とパターン

### 2. Conventions（規約）
**目的**: コーディング標準とスタイル設定
**基準**:
- 命名規則: 変数、関数、クラスの命名パターン
- コードスタイル: フォーマット、インデント、括弧の配置
- コメント標準: ドキュメント形式と要件
- エラー処理: エラーの処理方法
- テストパターン: テストファイルの組織と命名

### 3. Architecture（アーキテクチャ）
**目的**: システム設計とアーキテクチャの決定
**基準**:
- デザインパターン: どのパターンがどこで使用されているか
- 技術スタック: 選択された技術とその理由
- システム境界: サービス境界とインターフェース
- データフロー: システム内でのデータの移動方法
- セキュリティの考慮事項: セキュリティパターンと実践

### 4. Preferences（設定）
**目的**: ユーザー固有のコーディング設定
**基準**:
- 優先ライブラリ: 一般的なタスク用の定番ライブラリ
- コード生成: テンプレートとスニペット
- ツール設定: エディタとツールの設定
- ワークフロー設定: タスクへのアプローチ方法

### 5. Constraints（制約）
**目的**: 技術的な制限と要件
**基準**:
- パフォーマンス要件: 速度とリソースの制約
- 互換性要件: ブラウザ、OS、バージョンサポート
- 規制コンプライアンス: 法的およびコンプライアンス要件
- 技術的負債: 既知の問題と回避策

## 移行パス

### フェーズ1: 共存
- ステアリングシステムを追加しながらMemory MCPを機能的に保つ
- メモリからステアリングファイルへの手動移行を許可

### フェーズ2: 非推奨化
- Memory MCPを非推奨としてマーク
- 既存メモリ用の移行ツールを提供

### フェーズ3: 削除
- Memory MCPコンポーネントを削除
- 未使用の依存関係をクリーンアップ

## 成功指標
- 移行中のデータ損失ゼロ
- 既存メモリの100%が正常に移行される
- ステアリングファイルがバージョン管理される
- チームメンバーがステアリングファイルを共有・マージできる
